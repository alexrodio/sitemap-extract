# Планирование Проекта: Sitemap Extract

## Содержание

1. [Списки Задач (Todo Lists)](#списки-задач-todo-lists)
2. [Файловое Дерево](#файловое-дерево)
3. [Контракты Модулей](#контракты-модулей)
4. [Обязанности Компонентов](#обязанности-компонентов)

---

# Списки Задач (Todo Lists)

## Фаза 0: Подготовка Среды и Зависимостей

### Задачи Фазы 0

- [ ] **0.1** Установка Python 3.7+ на целевую систему
  - Проверить версию Python
  - Убедиться в доступности pip
  - Проверить переменные окружения PATH

- [ ] **0.2** Создание виртуального окружения
  - Создать venv для изоляции зависимостей
  - Активировать виртуальное окружение
  - Документировать команды активации для разных ОС

- [ ] **0.3** Подготовка requirements.txt
  - Создать файл requirements.txt
  - Добавить cloudscraper==1.2.58
  - Добавить argparse==1.4.0
  - Документировать назначение каждой зависимости

- [ ] **0.4** Установка зависимостей
  - Выполнить pip install -r requirements.txt
  - Проверить успешность установки всех пакетов
  - Протестировать импорт критических модулей

- [ ] **0.5** Настройка системы контроля версий
  - Инициализировать git репозиторий
  - Создать .gitignore для Python проектов
  - Добавить исключения для логов и выходных файлов
  - Настроить исключения для виртуального окружения

---

## Фаза 1: Базовая Инфраструктура

### Задачи Фазы 1

- [ ] **1.1** Создание структуры пакета
  - Создать директорию sitemap_extract
  - Создать пустой файл __init__.py в корне пакета
  - Документировать назначение пакетной структуры

- [ ] **1.2** Создание модуля констант
  - Создать файл constants.py
  - Определить константу XML_NAMESPACE
  - Определить список USER_AGENTS
  - Определить DEFAULT_MAX_WORKERS
  - Определить DEFAULT_LOG_FILE
  - Определить DEFAULT_LOG_FORMAT
  - Добавить документацию для всех констант

- [ ] **1.3** Настройка системы логирования
  - Создать модуль logger.py
  - Реализовать функцию setup_logging
  - Настроить формат логов: timestamp - level - message
  - Установить уровень логирования DEBUG
  - Настроить вывод в файл sitemap_processing.log
  - Документировать конфигурацию логирования

- [ ] **1.4** Создание типов данных
  - Создать модуль types.py
  - Определить именованные типы для URL (строки)
  - Определить типы для коллекций URL (List, Set)
  - Определить тип для результатов обработки (Tuple)
  - Документировать все определения типов

- [ ] **1.5** Создание модуля исключений
  - Создать файл exceptions.py
  - Определить базовый класс SitemapExtractError
  - Определить NetworkError для сетевых ошибок
  - Определить ParseError для ошибок парсинга
  - Определить FileOperationError для файловых ошибок
  - Документировать иерархию исключений

---

## Фаза 2: Модуль Сетевого Взаимодействия

### Задачи Фазы 2

- [ ] **2.1** Создание базового HTTP клиента
  - Создать модуль network.py
  - Реализовать функцию create_scraper
  - Параметр use_cloudscraper для выбора библиотеки
  - Параметр use_proxy для настройки прокси
  - Логика условного импорта requests при отключенном cloudscraper
  - Документировать параметры и возвращаемые значения

- [ ] **2.2** Реализация механизма ротации User-Agent
  - Создать функцию get_random_user_agent
  - Использовать константу USER_AGENTS
  - Применить random.choice для выбора
  - Документировать механизм ротации

- [ ] **2.3** Реализация функции загрузки XML
  - Создать функцию fetch_xml
  - Параметр url (строка)
  - Параметр use_cloudscraper (boolean)
  - Параметр use_proxy (boolean)
  - Создание HTTP клиента через create_scraper
  - Установка случайного User-Agent
  - Выполнение GET запроса
  - Проверка статуса через raise_for_status
  - Парсинг response.content в ElementTree
  - Обработка исключений с логированием
  - Возврат ElementTree.Element или None
  - Документировать все параметры и логику ошибок

- [ ] **2.4** Реализация функции декомпрессии GZ
  - Создать функцию decompress_gz
  - Идентичная сигнатура с fetch_xml
  - Создание HTTP клиента
  - Установка User-Agent
  - GET запрос с параметром stream=True
  - Открытие response.raw через gzip.open в режиме 'rb'
  - Чтение полного содержимого
  - Парсинг в ElementTree
  - Обработка исключений
  - Возврат ElementTree.Element или None
  - Документировать потоковую обработку

- [ ] **2.5** Настройка прокси
  - Реализовать конфигурацию прокси в create_scraper
  - Параметр прокси-сервера (временно хардкоден)
  - Установка для http и https протоколов
  - Документировать формат прокси-URL
  - Добавить комментарий о необходимости конфигурации

- [ ] **2.6** Тестирование сетевого модуля
  - Создать тестовые сценарии для fetch_xml
  - Тест с валидным URL
  - Тест с невалидным URL
  - Тест с недоступным сервером
  - Тестирование decompress_gz с .gz файлом
  - Проверка ротации User-Agent
  - Проверка обработки HTTP ошибок
  - Документировать результаты тестирования

---

## Фаза 3: Модуль Парсинга XML

### Задачи Фазы 3

- [ ] **3.1** Создание модуля парсера
  - Создать файл parser.py
  - Импортировать необходимые типы из types.py
  - Импортировать константы из constants.py
  - Документировать назначение модуля

- [ ] **3.2** Реализация извлечения sitemap URLs
  - Создать функцию extract_sitemap_urls
  - Параметр root (ElementTree.Element)
  - Создание namespace dict с префиксом 'sm'
  - XPath запрос './/sm:sitemap'
  - Итерация по найденным элементам
  - Извлечение sm:loc для каждого
  - Получение текстового содержимого
  - Возврат списка URL
  - Обработка случая отсутствия элементов
  - Документировать логику XPath

- [ ] **3.3** Реализация извлечения page URLs
  - Создать функцию extract_page_urls
  - Параметр root (ElementTree.Element)
  - Использование того же namespace
  - XPath запрос './/sm:url'
  - Итерация и извлечение sm:loc
  - Возврат списка URL
  - Документировать различия с sitemap URLs

- [ ] **3.4** Реализация основной функции обработки
  - Создать функцию process_sitemap
  - Параметр url (string)
  - Параметр is_compressed (boolean)
  - Параметр use_cloudscraper (boolean)
  - Параметр use_proxy (boolean)
  - Логика выбора между fetch_xml и decompress_gz
  - Вызов extract_sitemap_urls если root получен
  - Вызов extract_page_urls если root получен
  - Инициализация пустых списков при ошибке загрузки
  - Возврат кортежа (sitemap_urls, page_urls)
  - Документировать логику обработки

- [ ] **3.5** Интеграция с модулем файловых операций
  - Импортировать функцию save_urls из file_operations
  - Добавить вызов save_urls если page_urls не пуст
  - Передать url и page_urls
  - Обработать возможные исключения
  - Документировать интеграцию

- [ ] **3.6** Тестирование парсера
  - Создать тестовый XML с sitemap элементами
  - Проверить корректность извлечения sitemap URLs
  - Создать тестовый XML с url элементами
  - Проверить корректность извлечения page URLs
  - Тест с пустым XML
  - Тест с невалидным namespace
  - Проверить обработку сжатых файлов
  - Документировать тестовые случаи

---

## Фаза 4: Модуль Файловых Операций

### Задачи Фазы 4

- [ ] **4.1** Создание модуля файловых операций
  - Создать файл file_operations.py
  - Импортировать os, glob
  - Импортировать logger
  - Документировать модуль

- [ ] **4.2** Реализация генерации имени файла
  - Создать функцию generate_filename
  - Параметр url (string)
  - Разбить URL по разделителю '/'
  - Взять последний элемент
  - Разбить по '.'
  - Взять первый элемент
  - Добавить расширение '.txt'
  - Возврат имени файла
  - Документировать алгоритм
  - Добавить предупреждение о возможных коллизиях

- [ ] **4.3** Реализация сохранения URL
  - Создать функцию save_urls
  - Параметр url (string) - исходный URL
  - Параметр urls (list) - список извлеченных URL
  - Генерация имени файла через generate_filename
  - Открытие файла в режиме записи 'w'
  - Запись строки "Source URL: {url}"
  - Итерация по urls с записью каждого на новой строке
  - Логирование количества сохраненных URL
  - Try-except блок с логированием ошибок
  - Документировать формат выходного файла

- [ ] **4.4** Реализация чтения URL из файла
  - Создать функцию read_urls_from_file
  - Параметр file_path (string)
  - Открытие файла в режиме чтения 'r'
  - Чтение всех строк
  - Применение strip() к каждой строке
  - Фильтрация пустых строк
  - Возврат списка URL
  - Try-except с возвратом пустого списка при ошибке
  - Логирование ошибок чтения
  - Документировать формат входного файла

- [ ] **4.5** Реализация поиска XML файлов
  - Создать функцию find_xml_files_in_directory
  - Параметр directory (string)
  - Создание паттерна для *.xml
  - Выполнение glob.glob для *.xml
  - Создание паттерна для *.xml.gz
  - Выполнение glob.glob для *.xml.gz
  - Объединение результатов в один список
  - Возврат списка путей
  - Try-except с возвратом пустого списка
  - Логирование ошибок сканирования
  - Документировать поддерживаемые форматы

- [ ] **4.6** Тестирование файловых операций
  - Тест генерации имени файла с различными URL
  - Тест сохранения URL в файл
  - Проверка формата выходного файла
  - Тест чтения URL из файла
  - Тест с пустым файлом
  - Тест с несуществующим файлом
  - Тест поиска в директории с XML файлами
  - Тест с пустой директорией
  - Документировать результаты

---

## Фаза 5: Модуль Управления Обработкой

### Задачи Фазы 5

- [ ] **5.1** Создание модуля оркестрации
  - Создать файл orchestrator.py
  - Импортировать concurrent.futures
  - Импортировать все необходимые функции из других модулей
  - Документировать назначение модуля

- [ ] **5.2** Реализация функции обработки всех карт
  - Создать функцию process_all_sitemaps
  - Параметр start_urls (list)
  - Параметр use_cloudscraper (boolean)
  - Параметр use_proxy (boolean)
  - Документировать назначение и параметры

- [ ] **5.3** Инициализация структур данных
  - Создать set для all_sitemap_urls
  - Создать set для all_page_urls
  - Создать list для queue
  - Скопировать start_urls в queue
  - Документировать назначение каждой структуры

- [ ] **5.4** Настройка ThreadPoolExecutor
  - Создать ThreadPoolExecutor с max_workers=5
  - Использовать context manager (with statement)
  - Документировать выбор количества потоков
  - Объяснить thread-safe операции

- [ ] **5.5** Реализация основного цикла обработки
  - Создать while цикл с условием "queue не пуста"
  - Извлечение первого URL (queue.pop(0) - FIFO)
  - Определение is_compressed через endswith('.xml.gz')
  - Создание Future через executor.submit
  - Передача функции process_sitemap
  - Передача параметров: url, is_compressed, use_cloudscraper, use_proxy
  - Документировать логику цикла

- [ ] **5.6** Обработка результатов Future
  - Вызов future.result() для получения данных
  - Распаковка результата в sitemap_urls и page_urls
  - Добавление sitemap_urls в all_sitemap_urls (set.update)
  - Добавление page_urls в all_page_urls (set.update)
  - Документировать обработку результатов

- [ ] **5.7** Динамическое расширение очереди
  - Итерация по полученным sitemap_urls
  - Проверка каждого URL на наличие в all_sitemap_urls
  - Добавление в queue только новых URL
  - Предотвращение дублирования и циклов
  - Документировать алгоритм предотвращения циклов

- [ ] **5.8** Обработка ошибок в пуле потоков
  - Try-except вокруг future.result()
  - Логирование ошибок обработки
  - Продолжение обработки при ошибке
  - Документировать fail-soft поведение

- [ ] **5.9** Финализация обработки
  - Проверка all_sitemap_urls на непустоту
  - Вызов save_urls для индексного файла
  - Имя файла "sitemap_index"
  - Возврат кортежа (all_sitemap_urls, all_page_urls)
  - Документировать финальные действия

- [ ] **5.10** Тестирование оркестратора
  - Тест с одиночным URL
  - Тест с множественными URL
  - Тест с вложенными картами (2-3 уровня)
  - Тест обработки ошибок
  - Проверка предотвращения циклов
  - Проверка thread-safety
  - Мониторинг использования потоков
  - Документировать результаты

---

## Фаза 6: CLI Интерфейс

### Задачи Фазы 6

- [ ] **6.1** Создание главного модуля
  - Создать файл main.py или __main__.py
  - Импортировать argparse
  - Импортировать logger
  - Импортировать все необходимые функции
  - Документировать структуру CLI

- [ ] **6.2** Создание ArgumentParser
  - Инициализировать ArgumentParser
  - Добавить description для программы
  - Документировать назначение парсера

- [ ] **6.3** Добавление аргумента --url
  - Определить аргумент --url
  - Тип: string
  - Help: описание назначения
  - Добавить пример использования в help

- [ ] **6.4** Добавление аргумента --file
  - Определить аргумент --file
  - Тип: string
  - Help: путь к файлу со списком URL
  - Описать формат файла в help

- [ ] **6.5** Добавление аргумента --directory
  - Определить аргумент --directory
  - Тип: string
  - Help: путь к директории с XML
  - Указать поддерживаемые форматы в help

- [ ] **6.6** Добавление флага --no-cloudscraper
  - Определить аргумент --no-cloudscraper
  - Action: store_true
  - Help: отключение Cloudscraper
  - Описать эффект отключения

- [ ] **6.7** Добавление флага --proxy
  - Определить аргумент --proxy
  - Action: store_true
  - Help: включение прокси
  - Добавить примечание о конфигурации

- [ ] **6.8** Парсинг и валидация аргументов
  - Вызов parser.parse_args()
  - Инициализация списка urls_to_process
  - Проверка наличия args.url
  - Проверка наличия args.file
  - Проверка наличия args.directory
  - Документировать логику валидации

- [ ] **6.9** Сбор URL из всех источников
  - Добавление args.url в список если существует
  - Чтение из файла через read_urls_from_file если args.file
  - Расширение списка прочитанными URL
  - Поиск файлов через find_xml_files_in_directory если args.directory
  - Расширение списка найденными путями
  - Документировать агрегацию источников

- [ ] **6.10** Валидация наличия источников
  - Проверка urls_to_process на пустоту
  - Логирование ошибки если пусто
  - Вызов parser.print_help()
  - Выход с кодом 1
  - Документировать обработку ошибки

- [ ] **6.11** Инициализация логирования
  - Вызов setup_logging в начале main
  - Логирование старта приложения
  - Документировать инициализацию

- [ ] **6.12** Запуск обработки
  - Логирование начала с количеством карт
  - Вызов process_all_sitemaps
  - Передача urls_to_process
  - Передача NOT args.no_cloudscraper
  - Передача args.proxy
  - Получение результатов (sitemaps, pages)
  - Документировать вызов

- [ ] **6.13** Финальное логирование
  - Логирование завершения обработки
  - Логирование количества найденных sitemap URLs
  - Логирование количества найденных page URLs
  - Документировать выходные логи

- [ ] **6.14** Создание entry point
  - Добавить if __name__ == "__main__"
  - Вызов главной функции
  - Документировать точку входа

- [ ] **6.15** Тестирование CLI
  - Тест с --url аргументом
  - Тест с --file аргументом
  - Тест с --directory аргументом
  - Тест с комбинацией аргументов
  - Тест с --no-cloudscraper
  - Тест с --proxy
  - Тест без аргументов (должна показаться справка)
  - Тест вывода help
  - Документировать все тестовые сценарии

---

## Фаза 7: Настройка Пакета и Развертывание

### Задачи Фазы 7

- [ ] **7.1** Создание setup.py
  - Импортировать setuptools
  - Определить name='sitemap_extract'
  - Установить version='1.0'
  - Использовать find_packages()
  - Добавить install_requires с зависимостями
  - Документировать конфигурацию

- [ ] **7.2** Настройка entry_points
  - Определить console_scripts
  - Создать точку входа sitemap_extract
  - Указать путь к main функции
  - Документировать использование entry point

- [ ] **7.3** Обновление __init__.py
  - Добавить __version__
  - Определить __all__ для экспорта
  - Добавить docstring модуля
  - Документировать публичный API

- [ ] **7.4** Создание MANIFEST.in
  - Включить README.md
  - Включить LICENSE
  - Включить requirements.txt
  - Документировать включаемые файлы

- [ ] **7.5** Обновление README.md
  - Добавить описание проекта
  - Документировать установку
  - Добавить примеры использования
  - Описать все CLI аргументы
  - Добавить раздел Features
  - Документировать требования
  - Добавить раздел с ограничениями

- [ ] **7.6** Создание LICENSE файла
  - Выбрать подходящую лицензию
  - Добавить текст лицензии
  - Указать автора и год
  - Документировать условия использования

- [ ] **7.7** Тестирование установки
  - Создать чистое виртуальное окружение
  - Установить пакет через pip install .
  - Проверить доступность команды sitemap_extract
  - Проверить импорт как библиотеки
  - Тест установки через pip install -e .
  - Документировать процесс установки

- [ ] **7.8** Создание скриптов развертывания
  - Создать скрипт для сборки пакета
  - Создать скрипт для запуска тестов
  - Создать скрипт для очистки
  - Документировать использование скриптов

---

## Фаза 8: Тестирование и Валидация

### Задачи Фазы 8

- [ ] **8.1** Создание тестовой инфраструктуры
  - Создать директорию tests/
  - Создать __init__.py в tests
  - Создать conftest.py для pytest fixtures
  - Установить pytest если используется
  - Документировать структуру тестов

- [ ] **8.2** Unit тесты для network модуля
  - Тест create_scraper с различными параметрами
  - Тест get_random_user_agent
  - Mock тесты для fetch_xml
  - Mock тесты для decompress_gz
  - Тест обработки HTTP ошибок
  - Тест обработки сетевых ошибок
  - Документировать тестовые случаи

- [ ] **8.3** Unit тесты для parser модуля
  - Тест extract_sitemap_urls с валидным XML
  - Тест extract_page_urls с валидным XML
  - Тест с пустым XML
  - Тест с невалидным namespace
  - Тест process_sitemap с mock загрузкой
  - Документировать покрытие

- [ ] **8.4** Unit тесты для file_operations модуля
  - Тест generate_filename с различными URL
  - Тест save_urls с созданием файла
  - Тест read_urls_from_file
  - Тест find_xml_files_in_directory
  - Тест обработки ошибок файловой системы
  - Документировать edge cases

- [ ] **8.5** Unit тесты для orchestrator модуля
  - Mock тесты для process_all_sitemaps
  - Тест обработки одного URL
  - Тест обработки множественных URL
  - Тест предотвращения циклов
  - Тест обработки ошибок
  - Документировать сложные сценарии

- [ ] **8.6** Integration тесты
  - Создать тестовые XML файлы
  - Тест end-to-end обработки одной карты
  - Тест обработки вложенных карт
  - Тест обработки сжатых файлов
  - Тест всех CLI аргументов
  - Проверка создания выходных файлов
  - Проверка логирования
  - Документировать интеграционные сценарии

- [ ] **8.7** Тесты производительности
  - Тест обработки большой карты
  - Измерение времени обработки
  - Мониторинг использования памяти
  - Проверка эффективности многопоточности
  - Документировать метрики производительности

- [ ] **8.8** Stress тестирование
  - Тест с сотнями вложенных карт
  - Тест с тысячами URL
  - Тест обработки ошибочных данных
  - Тест восстановления после сбоев
  - Документировать пределы системы

- [ ] **8.9** Валидация выходных данных
  - Проверка формата txt файлов
  - Проверка уникальности URL
  - Проверка полноты извлеченных данных
  - Валидация структуры логов
  - Документировать критерии валидации

- [ ] **8.10** Регрессионное тестирование
  - Создать набор reference тестов
  - Сравнение выхода с эталонным
  - Проверка обратной совместимости
  - Документировать регрессионные тесты

---

## Фаза 9: Документация

### Задачи Фазы 9

- [ ] **9.1** API документация
  - Создать docstrings для всех публичных функций
  - Использовать consistent format (Google/NumPy style)
  - Документировать параметры
  - Документировать возвращаемые значения
  - Документировать исключения
  - Добавить примеры использования

- [ ] **9.2** Документация модулей
  - Добавить module-level docstrings
  - Описать назначение каждого модуля
  - Документировать экспортируемые объекты
  - Добавить примеры использования модуля

- [ ] **9.3** Руководство пользователя
  - Создать USER_GUIDE.md
  - Раздел "Быстрый старт"
  - Детальное описание всех функций
  - Примеры использования для каждого режима
  - Описание всех CLI аргументов
  - Troubleshooting раздел
  - FAQ раздел

- [ ] **9.4** Руководство разработчика
  - Создать DEVELOPER_GUIDE.md
  - Описание архитектуры
  - Объяснение модульной структуры
  - Руководство по расширению
  - Coding standards
  - Процесс контрибуции

- [ ] **9.5** Генерация автодокументации
  - Настройка Sphinx (опционально)
  - Генерация HTML документации
  - Публикация на Read the Docs (опционально)

- [ ] **9.6** CHANGELOG
  - Создать CHANGELOG.md
  - Документировать версию 1.0
  - Список всех функций
  - Известные ограничения
  - Планы на будущее

---

## Фаза 10: Финализация и Релиз

### Задачи Фазы 10

- [ ] **10.1** Code review
  - Проверка соответствия спецификациям
  - Проверка качества кода
  - Проверка полноты документации
  - Проверка тестового покрытия
  - Рефакторинг если необходимо

- [ ] **10.2** Финальное тестирование
  - Запуск всех unit тестов
  - Запуск всех integration тестов
  - Запуск stress тестов
  - Проверка на различных ОС
  - Проверка с различными версиями Python

- [ ] **10.3** Оптимизация
  - Анализ узких мест производительности
  - Оптимизация критических путей
  - Оптимизация использования памяти
  - Документировать оптимизации

- [ ] **10.4** Подготовка к релизу
  - Финальное обновление README
  - Финальное обновление CHANGELOG
  - Проверка всех зависимостей
  - Создание release notes

- [ ] **10.5** Версионирование
  - Установка финальной версии 1.0.0
  - Создание git tag
  - Создание GitHub release (если применимо)

- [ ] **10.6** Публикация (опционально)
  - Создание дистрибутива (python setup.py sdist bdist_wheel)
  - Публикация на PyPI (опционально)
  - Документирование процесса публикации

- [ ] **10.7** Post-release
  - Мониторинг issues
  - Сбор обратной связи
  - Планирование следующей версии

---

# Файловое Дерево

## Предлагаемая Модульная Структура

sitemap-extract/
│
├── sitemap_extract/
│   ├── __init__.py
│   ├── __main__.py
│   ├── constants.py
│   ├── types.py
│   ├── exceptions.py
│   ├── logger.py
│   ├── network.py
│   ├── parser.py
│   ├── file_operations.py
│   ├── orchestrator.py
│   └── cli.py
│
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_network.py
│   ├── test_parser.py
│   ├── test_file_operations.py
│   ├── test_orchestrator.py
│   ├── test_cli.py
│   └── fixtures/
│       ├── sample_sitemap.xml
│       ├── sample_sitemap_index.xml
│       ├── sample_compressed.xml.gz
│       └── sample_urls.txt
│
├── docs/
│   ├── TECHNICAL_SPECIFICATIONS.md
│   ├── PROJECT_PLANNING.md
│   ├── USER_GUIDE.md
│   ├── DEVELOPER_GUIDE.md
│   └── API_REFERENCE.md
│
├── scripts/
│   ├── build.sh
│   ├── test.sh
│   ├── clean.sh
│   └── deploy.sh
│
├── .gitignore
├── setup.py
├── requirements.txt
├── requirements-dev.txt
├── MANIFEST.in
├── README.md
├── LICENSE
└── CHANGELOG.md

## Описание Структуры Директорий

### Корневая Директория (sitemap-extract/)
Содержит основные конфигурационные файлы проекта и директории модулей.

### sitemap_extract/ - Основной Пакет
Содержит весь исполняемый код приложения, разделенный по модулям ответственности.

### tests/ - Тестовая Директория
Содержит все unit и integration тесты, а также тестовые fixtures и mock данные.

### docs/ - Документация
Содержит всю проектную документацию, включая спецификации, руководства и API reference.

### scripts/ - Утилитные Скрипты
Содержит bash/shell скрипты для автоматизации задач разработки и развертывания.

## Описание Файлов Основного Пакета

### __init__.py
Маркер пакета Python, определяет публичный API, экспортирует основные функции и классы для использования как библиотеки.

### __main__.py
Entry point при запуске пакета как модуля (python -m sitemap_extract). Содержит вызов главной функции CLI.

### constants.py
Глобальные константы приложения:
- XML_NAMESPACE - namespace для sitemap XML
- USER_AGENTS - список User-Agent строк
- DEFAULT_MAX_WORKERS - количество потоков по умолчанию
- DEFAULT_LOG_FILE - имя файла логов
- DEFAULT_LOG_FORMAT - формат логирования
- DEFAULT_PROXY - placeholder для прокси URL

### types.py
Определения типов и type aliases для type hinting:
- URLType - alias для строки URL
- URLList - List[str] для списков URL
- URLSet - Set[str] для множеств URL
- ProcessResult - Tuple[URLSet, URLSet] для результатов обработки

### exceptions.py
Иерархия пользовательских исключений:
- SitemapExtractError - базовый класс
- NetworkError - ошибки сети
- ParseError - ошибки парсинга
- FileOperationError - ошибки файловых операций

### logger.py
Модуль настройки логирования:
- setup_logging() - конфигурация logger
- Настройка формата, уровня, файла вывода
- Вспомогательные функции логирования

### network.py
Модуль сетевого взаимодействия:
- create_scraper() - создание HTTP клиента
- get_random_user_agent() - ротация User-Agent
- fetch_xml() - загрузка XML по URL
- decompress_gz() - загрузка и декомпрессия GZ файлов
- Обработка HTTP запросов и ответов

### parser.py
Модуль парсинга XML:
- extract_sitemap_urls() - извлечение URL вложенных карт
- extract_page_urls() - извлечение URL страниц
- process_sitemap() - основная функция обработки одной карты
- Работа с XML namespace
- XPath запросы и извлечение данных

### file_operations.py
Модуль файловых операций:
- generate_filename() - генерация имени выходного файла
- save_urls() - сохранение URL в текстовый файл
- read_urls_from_file() - чтение URL из файла
- find_xml_files_in_directory() - поиск XML файлов в директории

### orchestrator.py
Модуль управления обработкой:
- process_all_sitemaps() - главная функция оркестрации
- Управление очередью обработки
- Координация ThreadPoolExecutor
- Агрегация результатов
- Предотвращение циклов и дублирования

### cli.py
Модуль интерфейса командной строки:
- setup_argument_parser() - настройка ArgumentParser
- validate_arguments() - валидация входных аргументов
- main() - главная функция CLI
- Обработка аргументов и запуск обработки

## Описание Тестовых Файлов

### conftest.py
Pytest конфигурация и общие fixtures для всех тестов.

### test_network.py
Unit тесты для модуля network:
- Тесты create_scraper
- Тесты fetch_xml с mock запросами
- Тесты decompress_gz
- Тесты обработки ошибок

### test_parser.py
Unit тесты для модуля parser:
- Тесты извлечения sitemap URLs
- Тесты извлечения page URLs
- Тесты обработки различных XML структур

### test_file_operations.py
Unit тесты для файловых операций:
- Тесты генерации имен файлов
- Тесты сохранения и чтения
- Тесты поиска файлов

### test_orchestrator.py
Unit тесты для orchestrator:
- Тесты процесса обработки
- Тесты многопоточности
- Тесты предотвращения циклов

### test_cli.py
Integration тесты CLI:
- Тесты всех аргументов
- End-to-end тесты
- Тесты валидации

### fixtures/
Тестовые данные:
- Примеры XML файлов различных структур
- Примеры сжатых файлов
- Примеры текстовых файлов с URL

## Описание Документационных Файлов

### TECHNICAL_SPECIFICATIONS.md
Полные технические спецификации приложения (уже создан).

### PROJECT_PLANNING.md
Планирование проекта с todo lists и структурой (этот документ).

### USER_GUIDE.md
Руководство пользователя с примерами использования всех функций.

### DEVELOPER_GUIDE.md
Руководство разработчика с описанием архитектуры и процессов.

### API_REFERENCE.md
Автоматически генерируемая документация API всех публичных функций.

## Описание Конфигурационных Файлов

### setup.py
Setuptools конфигурация для установки пакета:
- Метаданные пакета
- Зависимости
- Entry points
- Информация о пакете

### requirements.txt
Список production зависимостей:
- cloudscraper==1.2.58
- argparse==1.4.0

### requirements-dev.txt
Дополнительные зависимости для разработки:
- pytest
- pytest-cov
- pytest-mock
- black (code formatter)
- flake8 (linter)
- mypy (type checker)

### MANIFEST.in
Дополнительные файлы для включения в дистрибутив при публикации.

### .gitignore
Исключения для git:
- Виртуальные окружения
- Python cache файлы
- Логи
- Выходные txt файлы
- Build артефакты

### CHANGELOG.md
История изменений версий с описанием добавленных функций и исправлений.

---

# Контракты Модулей

## Контракт: constants.py

### Экспортируемые Константы

#### XML_NAMESPACE
- **Тип**: Dictionary[str, str]
- **Значение**: {'sm': 'http://www.sitemaps.org/schemas/sitemap/0.9'}
- **Назначение**: Namespace для XPath запросов к sitemap XML
- **Использование**: Передается во все функции парсинга XML

#### USER_AGENTS
- **Тип**: List[str]
- **Значение**: Список из 2+ User-Agent строк
- **Назначение**: Ротация User-Agent для HTTP запросов
- **Использование**: Случайный выбор при каждом запросе

#### DEFAULT_MAX_WORKERS
- **Тип**: int
- **Значение**: 5
- **Назначение**: Количество рабочих потоков в ThreadPoolExecutor
- **Использование**: Конфигурация пула потоков

#### DEFAULT_LOG_FILE
- **Тип**: str
- **Значение**: 'sitemap_processing.log'
- **Назначение**: Имя файла для логирования
- **Использование**: Конфигурация logger

#### DEFAULT_LOG_FORMAT
- **Тип**: str
- **Значение**: '%(asctime)s - %(levelname)s - %(message)s'
- **Назначение**: Формат логирования
- **Использование**: Конфигурация logger

### Зависимости
Нет внешних зависимостей

### Используется В
- logger.py
- network.py
- parser.py
- orchestrator.py

---

## Контракт: exceptions.py

### Экспортируемые Классы

#### SitemapExtractError
- **Базовый класс**: Exception
- **Назначение**: Базовое исключение для всех ошибок приложения
- **Атрибуты**: message (str)

#### NetworkError
- **Базовый класс**: SitemapExtractError
- **Назначение**: Ошибки сетевого взаимодействия
- **Атрибуты**:
  - message (str) - описание ошибки
  - url (str) - URL где произошла ошибка
  - original_exception (Exception) - оригинальное исключение

#### ParseError
- **Базовый класс**: SitemapExtractError
- **Назначение**: Ошибки парсинга XML
- **Атрибуты**:
  - message (str) - описание ошибки
  - url (str) - URL источника XML
  - original_exception (Exception) - оригинальное исключение

#### FileOperationError
- **Базовый класс**: SitemapExtractError
- **Назначение**: Ошибки файловых операций
- **Атрибуты**:
  - message (str) - описание ошибки
  - file_path (str) - путь к файлу
  - operation (str) - тип операции (read/write)
  - original_exception (Exception) - оригинальное исключение

### Зависимости
Нет внешних зависимостей

### Используется В
Все модули для специфичной обработки ошибок

---

## Контракт: logger.py

### Экспортируемые Функции

#### setup_logging
- **Сигнатура**: setup_logging(log_file: str = DEFAULT_LOG_FILE, log_level: int = logging.DEBUG) -> None
- **Назначение**: Конфигурация системы логирования
- **Параметры**:
  - log_file (str): Путь к файлу логов
  - log_level (int): Уровень логирования
- **Возврат**: None
- **Исключения**: Нет
- **Побочные эффекты**:
  - Конфигурация глобального logger
  - Создание файла логов если не существует
- **Зависимости**:
  - logging (стандартная библиотека)
  - constants.DEFAULT_LOG_FILE
  - constants.DEFAULT_LOG_FORMAT

### Используется В
- cli.py (вызывается в начале main)

---

## Контракт: network.py

### Экспортируемые Функции

#### create_scraper
- **Сигнатура**: create_scraper(use_cloudscraper: bool = True, use_proxy: bool = False) -> Union[CloudScraper, requests.Session]
- **Назначение**: Создание HTTP клиента с настройками
- **Параметры**:
  - use_cloudscraper (bool): Использовать Cloudscraper или requests
  - use_proxy (bool): Включить прокси
- **Возврат**: Сконфигурированный HTTP клиент
- **Исключения**: Нет
- **Зависимости**:
  - cloudscraper
  - requests (условный импорт)

#### get_random_user_agent
- **Сигнатура**: get_random_user_agent() -> str
- **Назначение**: Получить случайный User-Agent из списка
- **Параметры**: Нет
- **Возврат**: Строка User-Agent
- **Исключения**: Нет
- **Зависимости**:
  - random
  - constants.USER_AGENTS

#### fetch_xml
- **Сигнатура**: fetch_xml(url: str, use_cloudscraper: bool = True, use_proxy: bool = False) -> Optional[ET.Element]
- **Назначение**: Загрузка и парсинг XML по URL
- **Параметры**:
  - url (str): URL XML файла
  - use_cloudscraper (bool): Использовать Cloudscraper
  - use_proxy (bool): Использовать прокси
- **Возврат**: ElementTree.Element или None при ошибке
- **Исключения**:
  - Все исключения перехватываются
  - Логируются через logger
- **Побочные эффекты**: HTTP запрос к внешнему серверу
- **Зависимости**:
  - xml.etree.ElementTree
  - create_scraper
  - get_random_user_agent
  - logger

#### decompress_gz
- **Сигнатура**: decompress_gz(url: str, use_cloudscraper: bool = True, use_proxy: bool = False) -> Optional[ET.Element]
- **Назначение**: Загрузка, декомпрессия и парсинг .gz XML файла
- **Параметры**: Идентичны fetch_xml
- **Возврат**: ElementTree.Element или None при ошибке
- **Исключения**:
  - Все исключения перехватываются
  - Логируются через logger
- **Побочные эффекты**:
  - HTTP запрос к внешнему серверу
  - Потоковая декомпрессия в памяти
- **Зависимости**:
  - gzip
  - xml.etree.ElementTree
  - create_scraper
  - get_random_user_agent
  - logger

### Используется В
- parser.py (вызовы fetch_xml и decompress_gz)

---

## Контракт: parser.py

### Экспортируемые Функции

#### extract_sitemap_urls
- **Сигнатура**: extract_sitemap_urls(root: ET.Element) -> List[str]
- **Назначение**: Извлечение URL вложенных sitemap из XML
- **Параметры**:
  - root (ET.Element): Корневой элемент XML дерева
- **Возврат**: Список URL вложенных карт
- **Исключения**: Нет (пустой список при отсутствии элементов)
- **Зависимости**:
  - constants.XML_NAMESPACE

#### extract_page_urls
- **Сигнатура**: extract_page_urls(root: ET.Element) -> List[str]
- **Назначение**: Извлечение URL страниц из sitemap XML
- **Параметры**:
  - root (ET.Element): Корневой элемент XML дерева
- **Возврат**: Список URL страниц
- **Исключения**: Нет (пустой список при отсутствии элементов)
- **Зависимости**:
  - constants.XML_NAMESPACE

#### process_sitemap
- **Сигнатура**: process_sitemap(url: str, is_compressed: bool = False, use_cloudscraper: bool = True, use_proxy: bool = False) -> Tuple[List[str], List[str]]
- **Назначение**: Полная обработка одной sitemap - загрузка, парсинг, извлечение
- **Параметры**:
  - url (str): URL sitemap
  - is_compressed (bool): Флаг .gz сжатия
  - use_cloudscraper (bool): Использовать Cloudscraper
  - use_proxy (bool): Использовать прокси
- **Возврат**: Кортеж (список sitemap URLs, список page URLs)
- **Исключения**: Нет (возврат пустых списков при ошибке)
- **Побочные эффекты**:
  - HTTP запрос через network модуль
  - Вызов file_operations.save_urls при наличии page URLs
- **Зависимости**:
  - network.fetch_xml
  - network.decompress_gz
  - extract_sitemap_urls
  - extract_page_urls
  - file_operations.save_urls
  - logger

### Используется В
- orchestrator.py (вызов process_sitemap из пула потоков)

---

## Контракт: file_operations.py

### Экспортируемые Функции

#### generate_filename
- **Сигнатура**: generate_filename(url: str) -> str
- **Назначение**: Генерация имени файла из URL
- **Параметры**:
  - url (str): URL sitemap
- **Возврат**: Имя файла с расширением .txt
- **Исключения**: Нет
- **Алгоритм**:
  1. Разбить по '/' и взять последний элемент
  2. Разбить по '.' и взять первый элемент
  3. Добавить '.txt'
- **Предупреждение**: Возможны коллизии имен файлов

#### save_urls
- **Сигнатура**: save_urls(url: str, urls: List[str]) -> None
- **Назначение**: Сохранение списка URL в текстовый файл
- **Параметры**:
  - url (str): Исходный URL (для header в файле)
  - urls (List[str]): Список URL для сохранения
- **Возврат**: None
- **Исключения**:
  - Все исключения перехватываются
  - Логируются через logger
- **Побочные эффекты**:
  - Создание/перезапись файла в текущей директории
  - Формат файла: первая строка "Source URL: {url}", затем по URL на строку
- **Зависимости**:
  - generate_filename
  - logger

#### read_urls_from_file
- **Сигнатура**: read_urls_from_file(file_path: str) -> List[str]
- **Назначение**: Чтение списка URL из текстового файла
- **Параметры**:
  - file_path (str): Путь к файлу
- **Возврат**: Список URL (пустой список при ошибке)
- **Исключения**:
  - Все исключения перехватываются
  - Логируются через logger
- **Формат входного файла**: Один URL на строку, пустые строки игнорируются
- **Зависимости**: logger

#### find_xml_files_in_directory
- **Сигнатура**: find_xml_files_in_directory(directory: str) -> List[str]
- **Назначение**: Поиск всех XML и XML.GZ файлов в директории
- **Параметры**:
  - directory (str): Путь к директории
- **Возврат**: Список полных путей к файлам (пустой при ошибке)
- **Исключения**:
  - Все исключения перехватываются
  - Логируются через logger
- **Поисковые паттерны**: *.xml и *.xml.gz
- **Зависимости**:
  - glob
  - os
  - logger

### Используется В
- parser.py (save_urls)
- cli.py (read_urls_from_file, find_xml_files_in_directory)

---

## Контракт: orchestrator.py

### Экспортируемые Функции

#### process_all_sitemaps
- **Сигнатура**: process_all_sitemaps(start_urls: List[str], use_cloudscraper: bool = True, use_proxy: bool = False) -> Tuple[Set[str], Set[str]]
- **Назначение**: Оркестрация обработки всех sitemap с поддержкой вложенности
- **Параметры**:
  - start_urls (List[str]): Начальные URL для обработки
  - use_cloudscraper (bool): Использовать Cloudscraper
  - use_proxy (bool): Использовать прокси
- **Возврат**: Кортеж (множество всех sitemap URLs, множество всех page URLs)
- **Исключения**: Нет (ошибки логируются, обработка продолжается)
- **Алгоритм**:
  1. Инициализация очереди и множеств
  2. Создание ThreadPoolExecutor
  3. Цикл обработки очереди (FIFO)
  4. Динамическое добавление вложенных sitemap
  5. Предотвращение циклов через множества
  6. Агрегация результатов
  7. Финальное сохранение индекса
- **Побочные эффекты**:
  - Множественные HTTP запросы
  - Создание множества выходных файлов
  - Создание файла sitemap_index.txt
  - Логирование всех операций
- **Многопоточность**:
  - ThreadPoolExecutor с max_workers из констант
  - Thread-safe операции с set
  - Future-based асинхронность
- **Зависимости**:
  - concurrent.futures.ThreadPoolExecutor
  - parser.process_sitemap
  - file_operations.save_urls
  - constants.DEFAULT_MAX_WORKERS
  - logger

### Используется В
- cli.py (главный вызов из main функции)

---

## Контракт: cli.py

### Экспортируемые Функции

#### setup_argument_parser
- **Сигнатура**: setup_argument_parser() -> argparse.ArgumentParser
- **Назначение**: Создание и настройка ArgumentParser
- **Параметры**: Нет
- **Возврат**: Сконфигурированный ArgumentParser
- **Аргументы**:
  - --url (str, optional): Прямой URL sitemap
  - --file (str, optional): Путь к файлу со списком URL
  - --directory (str, optional): Путь к директории с XML
  - --no-cloudscraper (flag): Отключить Cloudscraper
  - --proxy (flag): Включить прокси
- **Зависимости**: argparse

#### validate_arguments
- **Сигнатура**: validate_arguments(args: argparse.Namespace) -> List[str]
- **Назначение**: Валидация аргументов и сбор URL из всех источников
- **Параметры**:
  - args (Namespace): Распарсенные аргументы
- **Возврат**: Список URL для обработки
- **Исключения**:
  - SystemExit(1) если нет валидных источников
- **Побочные эффекты**:
  - Чтение файлов через file_operations
  - Логирование ошибок
  - Вывод справки при ошибке
- **Зависимости**:
  - file_operations.read_urls_from_file
  - file_operations.find_xml_files_in_directory
  - logger

#### main
- **Сигнатура**: main() -> None
- **Назначение**: Главная функция CLI, entry point приложения
- **Параметры**: Нет
- **Возврат**: None
- **Алгоритм**:
  1. Инициализация логирования
  2. Парсинг аргументов
  3. Валидация и сбор URL
  4. Запуск обработки через orchestrator
  5. Финальное логирование результатов
- **Побочные эффекты**:
  - Вся логика приложения
  - Создание файлов
  - HTTP запросы
  - Логирование
- **Зависимости**:
  - logger.setup_logging
  - setup_argument_parser
  - validate_arguments
  - orchestrator.process_all_sitemaps

### Используется В
- __main__.py (вызов main при запуске модуля)
- setup.py (entry point для console script)

---

## Контракт: __main__.py

### Назначение
Entry point для запуска пакета как модуля (python -m sitemap_extract).

### Содержимое
```
if __name__ == "__main__":
    from sitemap_extract.cli import main
    main()
```

### Зависимости
- cli.main

---

## Контракт: __init__.py

### Экспортируемый API

#### __version__
- **Тип**: str
- **Значение**: "1.0.0"

#### Экспортируемые функции для использования как библиотека
- process_all_sitemaps (из orchestrator)
- process_sitemap (из parser)
- read_urls_from_file (из file_operations)
- find_xml_files_in_directory (из file_operations)

#### __all__
Определяет публичный API пакета для import *

### Module Docstring
Описание пакета, основные возможности, примеры использования

---

# Обязанности Компонентов

## Модуль: constants.py

### Основная Обязанность
Централизованное хранение всех констант и конфигурационных значений приложения.

### Конкретные Обязанности

1. **Управление XML Конфигурацией**
   - Определение namespace для sitemap XML
   - Обеспечение консистентности namespace во всем приложении

2. **Конфигурация User-Agent**
   - Хранение списка валидных User-Agent строк
   - Обеспечение разнообразия для ротации

3. **Конфигурация Многопоточности**
   - Определение количества рабочих потоков
   - Централизованная настройка параллелизма

4. **Конфигурация Логирования**
   - Определение имени файла логов
   - Определение формата логирования
   - Обеспечение консистентности логирования

5. **Конфигурация Сети**
   - Хранение значений по умолчанию для прокси
   - Централизованное управление сетевыми настройками

### НЕ Отвечает За
- Логику обработки данных
- Выполнение операций
- Изменение значений во время выполнения (immutable)

---

## Модуль: exceptions.py

### Основная Обязанность
Определение иерархии исключений для специфичной обработки ошибок.

### Конкретные Обязанности

1. **Базовое Исключение**
   - Определение SitemapExtractError как корневого класса
   - Общий интерфейс для всех исключений приложения

2. **Сетевые Исключения**
   - Определение NetworkError для HTTP/сетевых ошибок
   - Хранение контекста: URL, оригинальное исключение

3. **Исключения Парсинга**
   - Определение ParseError для ошибок XML
   - Сохранение контекста парсинга

4. **Файловые Исключения**
   - Определение FileOperationError для I/O ошибок
   - Различение операций чтения/записи

5. **Структурирование Ошибок**
   - Создание понятной иерархии
   - Облегчение специфичной обработки ошибок

### НЕ Отвечает За
- Непосредственную обработку ошибок (только определение)
- Логирование ошибок
- Восстановление после ошибок

---

## Модуль: logger.py

### Основная Обязанность
Конфигурация и управление системой логирования приложения.

### Конкретные Обязанности

1. **Инициализация Logger**
   - Настройка глобального logger
   - Применение конфигурации из констант

2. **Конфигурация Формата**
   - Установка формата логов (timestamp, level, message)
   - Обеспечение консистентности формата

3. **Настройка Вывода**
   - Конфигурация записи в файл
   - Установка имени файла логов

4. **Управление Уровнями**
   - Установка уровня логирования (DEBUG)
   - Фильтрация сообщений по уровню

5. **Обеспечение Доступности**
   - Предоставление сконфигурированного logger всем модулям
   - Единая точка конфигурации

### НЕ Отвечает За
- Непосредственное логирование событий (делают другие модули)
- Анализ логов
- Ротацию логов (не реализовано)

---

## Модуль: network.py

### Основная Обязанность
Все аспекты сетевого взаимодействия и HTTP коммуникации.

### Конкретные Обязанности

1. **Создание HTTP Клиентов**
   - Инициализация Cloudscraper или requests.Session
   - Конфигурация в зависимости от параметров
   - Управление прокси настройками

2. **Ротация User-Agent**
   - Случайный выбор User-Agent из списка
   - Обеспечение разнообразия запросов
   - Снижение вероятности блокировки

3. **Загрузка XML Данных**
   - Выполнение GET запросов к URL
   - Установка заголовков
   - Проверка HTTP статусов
   - Парсинг ответа в ElementTree

4. **Обработка Сжатых Данных**
   - Потоковая загрузка .gz файлов
   - Декомпрессия через gzip
   - Парсинг декомпрессированного XML

5. **Обработка Сетевых Ошибок**
   - Перехват всех сетевых исключений
   - Логирование с полным контекстом
   - Graceful degradation (возврат None)

6. **Антибот Обход**
   - Интеграция с Cloudscraper
   - Обработка JavaScript challenges
   - Управление cookies и сессиями

### НЕ Отвечает За
- Парсинг структуры XML (только загрузка)
- Логику обработки sitemap
- Сохранение данных
- Управление очередью запросов

---

## Модуль: parser.py

### Основная Обязанность
Парсинг XML структур sitemap и извлечение URL.

### Конкретные Обязанности

1. **Извлечение Sitemap URLs**
   - XPath навигация с namespace
   - Поиск элементов <sitemap>
   - Извлечение значений <loc>
   - Возврат списка вложенных карт

2. **Извлечение Page URLs**
   - XPath навигация с namespace
   - Поиск элементов <url>
   - Извлечение значений <loc>
   - Возврат списка страниц

3. **Координация Обработки Одной Карты**
   - Выбор метода загрузки (обычный/сжатый)
   - Вызов функций извлечения
   - Агрегация результатов
   - Инициация сохранения при наличии данных

4. **Обработка XML Namespace**
   - Использование правильного namespace
   - Обеспечение корректности XPath запросов

5. **Обработка Ошибок Парсинга**
   - Graceful handling отсутствующих элементов
   - Возврат пустых списков при ошибках
   - Логирование проблем парсинга

### НЕ Отвечает За
- Загрузку XML (делегирует network модулю)
- Сохранение результатов (делегирует file_operations)
- Управление множественными картами
- Многопоточность

---

## Модуль: file_operations.py

### Основная Обязанность
Все операции с файловой системой.

### Конкретные Обязанности

1. **Генерация Имен Файлов**
   - Извлечение имени из URL
   - Очистка от расширений
   - Добавление .txt расширения
   - Обеспечение валидности имен

2. **Сохранение URL в Файлы**
   - Создание текстовых файлов
   - Запись header с исходным URL
   - Запись всех URL построчно
   - Логирование успешных операций

3. **Чтение URL из Файлов**
   - Открытие и чтение файлов
   - Парсинг построчно
   - Очистка whitespace
   - Фильтрация пустых строк

4. **Поиск XML Файлов**
   - Сканирование директорий
   - Поиск по паттернам (*.xml, *.xml.gz)
   - Возврат полных путей
   - Обработка несуществующих директорий

5. **Обработка Файловых Ошибок**
   - Перехват IOError, FileNotFoundError, PermissionError
   - Логирование с контекстом
   - Graceful degradation

### НЕ Отвечает За
- Обработку содержимого файлов
- Парсинг XML
- Сетевые операции
- Логику бизнес-процессов

---

## Модуль: orchestrator.py

### Основная Обязанность
Оркестрация процесса обработки множественных sitemap с управлением многопоточностью.

### Конкретные Обязанности

1. **Управление Очередью**
   - Инициализация очереди стартовыми URL
   - FIFO извлечение URL
   - Динамическое добавление вложенных карт
   - Мониторинг состояния очереди

2. **Координация Многопоточности**
   - Создание ThreadPoolExecutor
   - Управление пулом потоков
   - Submit задач для обработки
   - Сбор результатов через Future

3. **Предотвращение Циклов**
   - Отслеживание обработанных URL через set
   - Проверка перед добавлением в очередь
   - Гарантия однократной обработки

4. **Агрегация Результатов**
   - Сбор всех sitemap URLs в единое множество
   - Сбор всех page URLs в единое множество
   - Обеспечение уникальности

5. **Обработка Вложенности**
   - Breadth-first обход структуры
   - Обработка неограниченной глубины
   - Корректная обработка всех уровней

6. **Финализация Процесса**
   - Сохранение индексного файла
   - Возврат финальных результатов
   - Логирование итоговой статистики

7. **Отказоустойчивость**
   - Обработка ошибок в потоках
   - Продолжение при сбое одной задачи
   - Fail-soft поведение

### НЕ Отвечает За
- Детали парсинга XML
- Сетевую коммуникацию
- Файловые операции (делегирует)
- CLI интерфейс

---

## Модуль: cli.py

### Основная Обязанность
Интерфейс командной строки и точка входа для пользователя.

### Конкретные Обязанности

1. **Парсинг Аргументов**
   - Определение всех CLI аргументов
   - Парсинг пользовательского ввода
   - Генерация справочной информации

2. **Валидация Входных Данных**
   - Проверка наличия хотя бы одного источника
   - Валидация путей к файлам/директориям
   - Обеспечение корректности параметров

3. **Сбор URL из Источников**
   - Агрегация URL из --url аргумента
   - Чтение из файла через --file
   - Поиск в директории через --directory
   - Объединение всех источников

4. **Инициализация Системы**
   - Запуск логирования
   - Инициализация необходимых компонентов
   - Подготовка к обработке

5. **Координация Выполнения**
   - Вызов orchestrator с корректными параметрами
   - Передача настроек (cloudscraper, proxy)
   - Получение и обработка результатов

6. **Пользовательский Интерфейс**
   - Вывод справки при ошибках
   - Информирование о прогрессе (через логи)
   - Финальная статистика

7. **Обработка Ошибок Верхнего Уровня**
   - Перехват критических ошибок
   - Корректное завершение программы
   - Возврат правильных exit codes

### НЕ Отвечает За
- Логику обработки sitemap
- Сетевые операции
- Парсинг XML
- Файловые операции (кроме чтения входных данных)

---

## Модуль: __main__.py

### Основная Обязанность
Entry point для запуска пакета как модуля.

### Конкретные Обязанности

1. **Точка Входа Модуля**
   - Обеспечение запуска через python -m sitemap_extract
   - Импорт и вызов main функции из cli

2. **Минимальная Логика**
   - Только импорт и вызов
   - Без дополнительной бизнес-логики

### НЕ Отвечает За
- Любую логику приложения (делегирует cli.main)

---

## Модуль: __init__.py

### Основная Обязанность
Определение публичного API пакета для использования как библиотеки.

### Конкретные Обязанности

1. **Определение Версии**
   - Хранение __version__
   - Обеспечение доступности версии

2. **Экспорт Публичного API**
   - Определение __all__
   - Импорт и реэкспорт основных функций
   - Предоставление удобного интерфейса

3. **Документация Пакета**
   - Module-level docstring
   - Описание основных возможностей
   - Примеры использования как библиотеки

4. **Инициализация Пакета**
   - Выполнение необходимой инициализации
   - Настройка пакетного окружения

### НЕ Отвечает За
- Реализацию функциональности
- Выполнение бизнес-логики
- CLI интерфейс

---

# Матрица Зависимостей Модулей

## Граф Зависимостей

constants.py
    ↓
    ├── logger.py
    ├── network.py
    ├── parser.py
    └── orchestrator.py

exceptions.py
    ↓
    └── (Все модули - опциональное использование)

logger.py
    ↓
    ├── network.py
    ├── parser.py
    ├── file_operations.py
    ├── orchestrator.py
    └── cli.py

network.py
    ↓
    └── parser.py

file_operations.py
    ↓
    ├── parser.py
    └── cli.py

parser.py
    ↓
    └── orchestrator.py

orchestrator.py
    ↓
    └── cli.py

cli.py
    ↓
    └── __main__.py

## Порядок Разработки (Bottom-Up)

1. **Уровень 0** (Нет зависимостей):
   - constants.py
   - exceptions.py

2. **Уровень 1** (Зависят только от уровня 0):
   - logger.py

3. **Уровень 2** (Зависят от уровней 0-1):
   - network.py
   - file_operations.py

4. **Уровень 3** (Зависят от уровней 0-2):
   - parser.py

5. **Уровень 4** (Зависят от уровней 0-3):
   - orchestrator.py

6. **Уровень 5** (Зависят от всех предыдущих):
   - cli.py

7. **Уровень 6** (Entry points):
   - __main__.py
   - __init__.py

---

# Рекомендации по Реализации

## Общие Принципы

1. **Модульность**
   - Каждый модуль имеет четко определенную ответственность
   - Минимизация зависимостей между модулями
   - Использование dependency injection где возможно

2. **Инверсия Зависимостей**
   - Зависимость от абстракций, не от конкретных реализаций
   - Возможность замены компонентов

3. **Обработка Ошибок**
   - Fail-soft стратегия на всех уровнях
   - Детальное логирование всех ошибок
   - Сохранение контекста при исключениях

4. **Тестируемость**
   - Возможность mock всех внешних зависимостей
   - Изолированность unit тестов
   - Четкие контракты для integration тестов

5. **Документация**
   - Docstrings для всех публичных функций
   - Комментарии для сложной логики
   - Примеры использования в документации

6. **Type Hints**
   - Использование type hints везде где возможно
   - Проверка через mypy
   - Улучшение читаемости и поддерживаемости

## Порядок Внедрения

1. **Начать с фундамента** - константы и исключения
2. **Построить инфраструктуру** - логирование
3. **Реализовать периферийные модули** - network, file_operations
4. **Построить ядро** - parser
5. **Добавить оркестрацию** - orchestrator
6. **Создать интерфейс** - CLI
7. **Тестировать на каждом этапе**
8. **Интегрировать и валидировать**

## Критерии Готовности Каждого Модуля

- [ ] Код соответствует спецификациям
- [ ] Все функции имеют docstrings
- [ ] Type hints для всех параметров и возвратов
- [ ] Unit тесты написаны и проходят
- [ ] Обработка ошибок реализована
- [ ] Логирование добавлено где необходимо
- [ ] Code review пройден
- [ ] Документация обновлена

---

# Заключение

Этот документ предоставляет полный план разработки приложения Sitemap Extract, включающий:

- **Детальные Todo Lists** по фазам разработки
- **Предложенную модульную структуру файлов**
- **Четкие контракты** между всеми модулями
- **Определенные обязанности** каждого компонента

Следуя этому плану, разработчик может последовательно создать приложение с нуля, имея ясное понимание:
- Что нужно сделать (Todo Lists)
- Где это будет располагаться (Файловое дерево)
- Как компоненты взаимодействуют (Контракты)
- За что отвечает каждый модуль (Обязанности)

Структура обеспечивает:
- **Модульность** - четкое разделение ответственности
- **Тестируемость** - изолированные компоненты
- **Расширяемость** - легкость добавления функций
- **Поддерживаемость** - понятная структура и документация
